<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valby Weather - TRMNL</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #ffffff;
            color: #000000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 6px;
            width: 400px;
            height: 480px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        /* TRMNL half-page (right side) - optimized for eink */
        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        /* Header */
        .header {
            text-align: center;
            padding-bottom: 4px;
            margin-bottom: 4px;
            border-bottom: 1px solid #000000;
        }

        .title {
            font-size: 18px;
            font-weight: 900;
            letter-spacing: 1px;
        }

        .timestamp {
            font-size: 10px;
            margin-top: 2px;
            opacity: 0.8;
            font-weight: 600;
        }

        /* Row sections */
        .row {
            padding: 6px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-bottom: 1px solid #000000;
            overflow: hidden;
        }

        .row:last-child {
            border-bottom: none;
        }

        .row-title {
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 3px;
        }

        .row-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 6px;
        }

        /* Today's weather row */
        .weather-today {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
        }

        .weather-icon {
            font-size: 64px;
            min-width: 64px;
            text-align: center;
            line-height: 1;
        }

        .weather-info {
            flex: 1;
            text-align: center;
        }

        .temp {
            font-size: 36px;
            font-weight: 900;
        }

        .condition {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 2px;
            font-weight: 700;
        }

        .feels-like {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 1px;
            font-weight: 600;
        }

        /* Precipitation row */
        .precipitation-row {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .precip-section-label {
            margin-bottom: 0;
            font-size: 9px;
            font-weight: 900;
            opacity: 0.8;
            text-align: center;
        }

        .hourly-precip {
            display: flex;
            gap: 1px;
            margin-bottom: 0;
            justify-content: space-between;
            align-items: flex-end;
            height: 50px;
        }

        .hour-slot {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            height: 100%;
            gap: 1px;
        }

        .hour-time {
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            width: 100%;
        }

        .hour-bar {
            width: 100%;
            background-color: #000;
            min-height: 2px;
        }

        .hour-dot {
            width: 100%;
            height: 2px;
            background-color: #000;
        }

        .hour-precip-text {
            font-size: 12px;
            font-weight: 700;
            text-align: center;
            width: 100%;
        }

        .hour-chance-text {
            display: none;
        }

        .aggregated-precip {
            display: none;
        }

        .agg-slot {
            display: none;
        }

        /* Next 3 days row */
        .forecast-row {
            display: flex;
            justify-content: space-between;
            gap: 6px;
            width: 100%;
            align-items: center;
        }

        .forecast-day {
            flex: 1;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 2px;
        }

        .forecast-day:last-child {
            padding-right: 0;
        }

        .day-name {
            font-size: 12px;
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 0;
            letter-spacing: 1px;
        }

        .day-icon {
            font-size: 0;
            margin: 0;
            display: none;
        }

        .day-temp {
            font-size: 18px;
            font-weight: 900;
        }

        .day-temp-low {
            font-size: 12px;
            opacity: 0.7;
            font-weight: 700;
        }

        .day-precip {
            font-size: 9px;
            opacity: 0.8;
            margin-top: 2px;
            font-weight: 700;
        }

        /* Loading and error states */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 14px;
        }

        .error {
            color: #000000;
            font-size: 12px;
            padding: 10px;
            text-align: center;
        }

        /* Optimize for eink - disable anti-aliasing */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #ffffff;
                color: #000000;
            }
        }

        /* Print/eink optimizations */
        @media print {
            body {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">Copenhagen Weather</div>
            <div class="timestamp" id="timestamp"></div>
        </div>

        <!-- Row 1: Today's Weather -->
        <div class="row">
            <div class="row-title">Today's Weather</div>
            <div class="row-content">
                <div class="weather-today">
                    <div class="weather-icon" id="currentIcon"></div>
                    <div class="weather-info">
                        <div class="temp"><span id="currentTemp">--</span>¬∞C</div>
                        <div class="condition" id="currentCondition">Loading...</div>
                        <div class="feels-like" id="feelsLike"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Precipitation -->
        <div class="row">
            <div class="row-title">Precipitation (Next 12h)</div>
            <div class="row-content">
                <div class="precipitation-row">
                    <div class="hourly-precip" id="hourlyContainer"></div>
                </div>
            </div>
        </div>

        <!-- Row 3: Next 3 Days -->
        <div class="row">
            <div class="row-title">Next 3 Days</div>
            <div class="forecast-row" id="forecastContainer">
                <div class="forecast-day">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const COPENHAGEN_LAT = 55.7186;
        const COPENHAGEN_LON = 12.4861;
        const USER_AGENT = 'TRMNL-Weather (valby-copenhagen) https://github.com/ldalboel/trmnlweather';

        async function fetchWeather() {
            try {
                // Fetch from Norwegian Meteorological Institute
                const response = await fetch(
                    `https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${COPENHAGEN_LAT}&lon=${COPENHAGEN_LON}`,
                    {
                        headers: {
                            'User-Agent': USER_AGENT
                        }
                    }
                );

                if (!response.ok) throw new Error('Weather API error: ' + response.status);

                const data = await response.json();
                updateWeather(data);
            } catch (error) {
                console.error('Error fetching weather:', error);
                document.querySelector('.container').innerHTML = 
                    '<div class="error">Unable to load weather data</div>';
            }
        }

        function getWeatherIcon(symbolCode) {
            // Norwegian Meteorological Institute weather symbols to emoji mapping
            const iconMap = {
                'clearsky_day': '‚òÄÔ∏è',
                'clearsky_night': 'üåô',
                'cloudy': '‚òÅÔ∏è',
                'fair_day': '‚õÖ',
                'fair_night': '‚õÖ',
                'fog': 'üå´Ô∏è',
                'lightrain': 'üåßÔ∏è',
                'lightrain_and_thunder': '‚õàÔ∏è',
                'lightsnow': 'üå®Ô∏è',
                'lightsnow_and_thunder': '‚õàÔ∏è',
                'rain': 'üåßÔ∏è',
                'rain_and_thunder': '‚õàÔ∏è',
                'snow': '‚ùÑÔ∏è',
                'snow_and_thunder': '‚õàÔ∏è',
                'heavyrain': 'üåßÔ∏è',
                'heavyrain_and_thunder': '‚õàÔ∏è',
                'heavysnow': '‚ùÑÔ∏è',
                'heavysnow_and_thunder': '‚õàÔ∏è',
                'sleet': 'üåßÔ∏è',
                'sleet_and_thunder': '‚õàÔ∏è',
                'rainshower_day': 'üåßÔ∏è',
                'rainshower_night': 'üåßÔ∏è',
                'snowshower_day': 'üå®Ô∏è',
                'snowshower_night': 'üå®Ô∏è',
                'partlycloudy_day': '‚õÖ',
                'partlycloudy_night': '‚õÖ'
            };

            // Extract base symbol (remove _day/_night suffix for lookup)
            const base = symbolCode.replace(/_(day|night)/, '');
            return iconMap[symbolCode] || iconMap[base] || 'üå°Ô∏è';
        }

        function getWeatherDescription(symbolCode) {
            const descriptions = {
                'clearsky_day': 'Clear',
                'clearsky_night': 'Clear',
                'cloudy': 'Cloudy',
                'fair_day': 'Fair',
                'fair_night': 'Fair',
                'fog': 'Fog',
                'lightrain': 'Light Rain',
                'lightrain_and_thunder': 'Rain & Thunder',
                'lightsnow': 'Light Snow',
                'lightsnow_and_thunder': 'Snow & Thunder',
                'rain': 'Rain',
                'rain_and_thunder': 'Rain & Thunder',
                'snow': 'Snow',
                'snow_and_thunder': 'Snow & Thunder',
                'heavyrain': 'Heavy Rain',
                'heavyrain_and_thunder': 'Heavy Rain & Thunder',
                'heavysnow': 'Heavy Snow',
                'heavysnow_and_thunder': 'Heavy Snow & Thunder',
                'sleet': 'Sleet',
                'sleet_and_thunder': 'Sleet & Thunder',
                'rainshower_day': 'Rain Showers',
                'rainshower_night': 'Rain Showers',
                'snowshower_day': 'Snow Showers',
                'snowshower_night': 'Snow Showers',
                'partlycloudy_day': 'Partly Cloudy',
                'partlycloudy_night': 'Partly Cloudy'
            };
            return descriptions[symbolCode] || 'Unknown';
        }

        function updateWeather(data) {
            const now = new Date();
            const timeseries = data.properties.timeseries;

            // Find current conditions (first entry)
            const current = timeseries[0];
            const currentData = current.data.instant.details;
            const currentSymbol = current.data.next_1_hours?.summary?.symbol_code || 'unknown';

            // Update timestamp
            document.getElementById('timestamp').textContent = 
                now.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

            // Row 1: Today's Weather
            const currentIcon = getWeatherIcon(currentSymbol);
            const currentTemp = Math.round(currentData.air_temperature);

            document.getElementById('currentIcon').textContent = currentIcon;
            document.getElementById('currentTemp').textContent = currentTemp;
            document.getElementById('currentCondition').textContent = getWeatherDescription(currentSymbol);
            document.getElementById('feelsLike').textContent = `Wind: ${Math.round(currentData.wind_speed)} km/h`;

            // Row 2: Precipitation - Next 12 hours as bars
            const hourlyContainer = document.getElementById('hourlyContainer');
            hourlyContainer.innerHTML = '';

            // Next 12 hours (hourly bars)
            for (let i = 0; i < 12 && i < timeseries.length; i++) {
                const entry = timeseries[i];
                const entryTime = new Date(entry.time);
                const hour = entryTime.getHours();
                const precip = entry.data.next_1_hours?.details?.precipitation_amount || 0;
                const chance = entry.data.next_1_hours?.details?.probability_of_precipitation || 0;

                const hourSlot = document.createElement('div');
                hourSlot.className = 'hour-slot';

                if (precip > 0) {
                    // Show bar with precipitation data
                    const barHeight = Math.min(Math.max(precip * 3, 8), 40); // Scale precipitation to bar height
                    const bar = document.createElement('div');
                    bar.className = 'hour-bar';
                    bar.style.height = barHeight + 'px';

                    const precipText = document.createElement('div');
                    precipText.className = 'hour-precip-text';
                    precipText.textContent = precip.toFixed(1);

                    const timeText = document.createElement('div');
                    timeText.className = 'hour-time';
                    timeText.textContent = hour.toString().padStart(2, '0');

                    hourSlot.appendChild(precipText);
                    hourSlot.appendChild(bar);
                    hourSlot.appendChild(timeText);
                } else {
                    // Show small bar for no precipitation
                    const bar = document.createElement('div');
                    bar.className = 'hour-bar';
                    bar.style.height = '2px';

                    const timeText = document.createElement('div');
                    timeText.className = 'hour-time';
                    timeText.textContent = hour.toString().padStart(2, '0');

                    hourSlot.appendChild(bar);
                    hourSlot.appendChild(timeText);
                }

                hourlyContainer.appendChild(hourSlot);
            }

            // Row 3: Next 3 Days Forecast
            const forecastContainer = document.getElementById('forecastContainer');
            forecastContainer.innerHTML = '';

            // Group by day
            const dailyForecasts = {};
            for (let i = 0; i < timeseries.length; i++) {
                const entry = timeseries[i];
                const entryTime = new Date(entry.time);
                const dayKey = entryTime.toDateString();
                
                if (!dailyForecasts[dayKey]) {
                    dailyForecasts[dayKey] = {
                        times: [],
                        temps: [],
                        symbols: [],
                        precips: []
                    };
                }
                
                dailyForecasts[dayKey].times.push(entryTime);
                dailyForecasts[dayKey].temps.push(entry.data.instant.details.air_temperature);
                dailyForecasts[dayKey].symbols.push(entry.data.next_1_hours?.summary?.symbol_code || 'unknown');
                dailyForecasts[dayKey].precips.push(entry.data.next_1_hours?.details?.probability_of_precipitation || 0);
            }

            // Display next 3 days
            const days = Object.entries(dailyForecasts).slice(1, 4);
            for (const [dayKey, dayData] of days) {
                const dayDate = dayData.times[0];
                const dayName = dayDate.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
                const maxTemp = Math.round(Math.max(...dayData.temps));
                const minTemp = Math.round(Math.min(...dayData.temps));
                const maxPrecipChance = Math.max(...dayData.precips);

                const forecastDay = document.createElement('div');
                forecastDay.className = 'forecast-day';
                forecastDay.innerHTML = `
                    <div class="day-name">${dayName}</div>
                    <div class="day-temp">${maxTemp}¬∞</div>
                    <div class="day-temp-low">${minTemp}¬∞</div>
                `;
                forecastContainer.appendChild(forecastDay);
            }
        }

        // Fetch weather on page load
        fetchWeather();

        // Refresh every 30 minutes
        setInterval(fetchWeather, 30 * 60 * 1000);
    </script>
</body>
</html>
